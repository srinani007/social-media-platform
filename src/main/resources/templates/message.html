<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="en" data-bs-theme="auto">
<head>
    <meta charset="UTF-8">
    <title>Messages – SocialSphere</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- Bootstrap & FontAwesome -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">

    <style>
        :root {
          --footer-height: 3rem;
          --bg-card: rgba(255,255,255,0.85);
          --bg-card-dark: rgba(33,37,41,0.85);
          --primary: #0d6efd;
          --primary-light: #e7f1ff;
          --text-dark: #212529;
          --text-light: #f8f9fa;
          --text-muted: #6c757d;
          --radius: 0.75rem;
          --shadow: rgba(0,0,0,0.1) 0px 2px 8px;
        }
        @media (prefers-color-scheme: dark) {
          :root {
            --bg-card: var(--bg-card-dark);
            --text-muted: #adb5bd;
          }
        }
        /* Sidebar & search */
        .sidebar, .mobile-sidebar {
          backdrop-filter: blur(8px);
        }
        .search-bar {
          display: flex;
          gap: .5rem;
          padding: .75rem 1rem;
          border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .search-bar input {
          border-radius: var(--radius);
          box-shadow: inset var(--shadow);
        }
        .search-bar button {
          width: 3rem;
          border-radius: var(--radius);
        }
        .form-control {
          display: block;
          border-radius: var(--radius);
          box-shadow: inset var(--shadow);
        }
        /* Conversation items */
        .list-group-item {
          border:#fd0df9;
          border-radius: var(--radius);
          margin: .25rem 1rem;
          padding: .75rem 1rem;
          transition: background .2s, transform .1s;
          position: relative;
        }
        .list-group-item:hover { background:gold; transform: translateY(-2px); }
        .list-group-item.unread { background: var(--primary-light); }
        .list-group-item.active { border-left: 4px solid var(--primary); }
        .unread-badge {
          position: absolute; right: 1.25rem; top: 50%;
          transform: translateY(-50%);
          background: var(--primary); color: #fff;
          border-radius: 50%; width: 1.5rem; height: 1.5rem;
          font-size: .75rem; line-height: 1.5rem;
        }
        /* Chat pane */
        .chat-pane {
          display: flex; flex-direction: column;
          box-shadow: var(--shadow);
        }
        .chat-header {
          position: sticky; top: 0; z-index: 10;
          display: flex; align-items: center; gap: .75rem;
          padding: .75rem 1rem; border-bottom: 1px solid rgba(0,0,0,0.05);
        }
        .chat-messages {
          flex: 1; overflow-y: auto; padding: 1rem;
          /* add extra bottom padding = footer + input height (~3rem) */
          padding-bottom: calc(var(--footer-height) + 3rem);
        }
        .msg {
          display: inline-block; max-width: 75%;
          padding: .75rem 1rem; margin-bottom: .75rem;
          border-radius: var(--radius); box-shadow: var(--shadow);
          line-height: 1.4;
        }
        .msg.sent {
          background: var(--primary);
          color: #fff;
          margin-left: auto;
        }
        .msg.received {
          color: var(--text-dark);
          margin-right: auto;
          border: 1px solid rgba(0,0,0,0.1);
        }
        /* stick the input right above the footer */
        .chat-input {
          position: sticky;
          bottom: var(--footer-height);
          z-index: 10;
          background: var(--bg-card);
          padding: .75rem 1rem;
          border-top: 1px solid rgba(0,0,0,0.05);
          display: flex;
          align-items: center;
          gap: .5rem;
        }
    </style>
</head>
<body>

<!-- Navbar -->
<div th:replace="~{fragments/navbar :: navbar}"></div>

<div class="container-fluid vh-100 p-0">
    <div class="row h-100 gx-0">

        <!-- DESKTOP SIDEBAR -->
        <aside class="col-md-2 d-none d-md-flex flex-column sidebar p-0">
            <div class="search-bar">
                <input id="search-desk" type="text" class="form-control" placeholder="Search…">
                <button id="new-desk" class="btn btn-primary"><i class="fas fa-plus"></i></button>
            </div>
            <div id="new-list-desk" class="list-group d-none">
                <a th:each="u : ${allUsers}"
                   th:href="@{'/messages/' + ${u.username}}"
                   class="list-group-item list-group-item-action"
                   th:unless="${u.username == #authentication.name}">
                    <span th:text="${u.fullName}">Name</span>
                </a>
            </div>
            <ul id="conv-desk" class="list-group list-group-flush flex-grow-1 overflow-auto">
                <li th:each="conv : ${conversations}"
                    class="list-group-item"
                    th:classappend="(${conv.unreadCount > 0} ? ' unread' : '') +
                              (${conv.username == selectedUsername} ? ' active' : '')">
                    <a th:href="@{'/messages/' + ${conv.username}}"
                       class="d-flex justify-content-between text-reset text-decoration-none">
                        <div>
                            <strong th:text="${conv.displayName}">Name</strong><br>
                            <small class="text-muted" th:text="${conv.lastMessageSnippet}">Snippet…</small>
                        </div>
                        <div class="text-end ms-2">
                            <small class="text-muted mb-1"
                                   th:text="${#temporals.format(conv.lastMessageTime,'h:mm a')}">4:21 PM</small>
                            <span th:if="${conv.unreadCount > 0}"
                                  class="unread-badge"
                                  th:text="${conv.unreadCount}">3</span>
                        </div>
                    </a>
                </li>
            </ul>
        </aside>

        <!-- DESKTOP CHAT -->
        <section class="col-md d-none d-md-flex flex-column chat-pane p-0">
            <div th:if="${selectedUsername == null}"
                 class="h-100 d-flex justify-content-center align-items-center text-muted">
                Select a conversation on the left.
            </div>
            <div th:if="${selectedUsername != null}" class="h-100 d-flex flex-column">
                <div class="chat-header">
                    <img th:src="${otherUser.profilePictureUrl ?: '/images/default-avatar.png'}"
                         class="rounded-circle" width="40" height="40" alt="avatar">
                    <div>
                        <strong th:text="${otherUser.fullName}">Full Name</strong><br>
                        <small class="text-muted" th:text="'@' + ${otherUser.username}">username</small>
                    </div>
                </div>
                <div id="messages" class="chat-messages">
                    <div th:each="msg : ${messages}"
                         class="d-flex mb-3"
                         th:classappend="${msg.sender.username == #authentication.name ? 'justify-content-end' : 'justify-content-start'}">
                        <div class="msg"
                             th:classappend="${msg.sender.username == #authentication.name ? 'sent' : 'received'}">
                            <div th:text="${msg.content}">Content</div>
                            <div class="text-end text-muted small mt-1"
                                 th:text="${#temporals.format(msg.sentAt,'h:mm a')}">12:00 PM</div>
                        </div>
                    </div>
                </div>
                <!-- send form (desktop + mobile share same markup) -->
                <form th:action="@{/messages/send}" method="post" class="chat-input">
                    <!-- CSRF token for Spring Security -->
                    <input type="hidden"
                           th:name="${_csrf.parameterName}"
                           th:value="${_csrf.token}" />
                    <!-- recipient & content -->
                    <input type="hidden" name="recipient" th:value="${selectedUsername}" />
                    <input name="content" class="form-control me-2"
                           placeholder="Type a message…" required />
                    <button class="btn btn-primary">Send</button>
                </form>
            </div>
        </section>

        <!-- MOBILE LAYOUT -->
        <div class="d-flex d-md-none flex-column vh-100 mobile-pane p-0">

            <!-- LIST VIEW: always in the DOM, just hidden when a user is selected -->
            <div id="list-pane"
                 class="flex-grow-1 d-flex flex-column"
                 th:classappend="${selectedUsername} != null ? ' d-none' : ''">
                <!-- your existing search bar + new-chat -->
                <div class="search-bar">
                    <input id="search-mob" type="text" class="form-control" placeholder="Search…">
                    <button id="new-mob" class="btn btn-primary"><i class="fas fa-plus"></i></button>
                </div>
                <div id="new-list-mob" class="list-group d-none">
                    <a th:each="u : ${allUsers}"
                       th:href="@{'/messages/' + ${u.username}}"
                       class="list-group-item list-group-item-action"
                       th:unless="${u.username == #authentication.name}">
                        <span th:text="${u.fullName}">Name</span>
                    </a>
                </div>
                <ul id="conv-mob" class="list-group list-group-flush flex-grow-1 overflow-auto">
                    <li th:each="conv : ${conversations}"
                        class="list-group-item"
                        th:classappend="(${conv.unreadCount} > 0 ? ' unread' : '')
                            + (${conv.username} == ${selectedUsername} ? ' active' : '')">
                        <a th:href="@{'/messages/' + ${conv.username}}"
                           class="d-flex justify-content-between text-reset text-decoration-none">
                            <div>
                                <strong th:text="${conv.displayName}">Name</strong><br>
                                <small class="text-muted" th:text="${conv.lastMessageSnippet}">Snippet…</small>
                            </div>
                            <div class="text-end ms-2">
                                <small class="text-muted mb-1"
                                       th:text="${#temporals.format(conv.lastMessageTime,'h:mm a')}">3:45 PM</small>
                                <span th:if="${conv.unreadCount > 0}"
                                      class="unread-badge"
                                      th:text="${conv.unreadCount}">3</span>
                            </div>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- CHAT VIEW: also always in the DOM, hidden when no user selected -->
            <div id="chat-pane"
                 class="flex-grow-1 d-flex flex-column"
                 th:classappend="${selectedUsername} == null ? ' d-none' : ''">
                <div class="chat-header">
                    <!-- BUTTON instead of a link, so we toggle in-page -->
                    <button id="back-btn" class="btn btn-link pe-2">←</button>
                    <img th:src="${otherUser.profilePictureUrl ?: '/images/default-avatar.png'}"
                         class="rounded-circle" width="40" height="40" alt="avatar">
                    <div>
                        <strong th:text="${otherUser.fullName}">Full Name</strong><br>
                        <small class="text-muted" th:text="'@' + ${otherUser.username}">username</small>
                    </div>
                </div>
                <div id="mob-messages" class="chat-messages">
                    <div th:each="msg : ${messages}"
                         class="d-flex mb-3"
                         th:classappend="${msg.sender.username == #authentication.name ? 'justify-content-end' : 'justify-content-start'}">
                        <div class="msg"
                             th:classappend="${msg.sender.username == #authentication.name ? 'sent' : 'received'}">
                            <div th:text="${msg.content}">Content</div>
                            <div class="text-end text-muted small mt-1"
                                 th:text="${#temporals.format(msg.sentAt,'h:mm a')}">12:00 PM</div>
                        </div>
                    </div>
                </div>
                <form th:action="@{/messages/send}" method="post" class="chat-input d-flex">
                    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
                    <input type="hidden" name="recipient" th:value="${selectedUsername}" />
                    <input name="content" class="form-control me-2" placeholder="Type a message…" required />
                    <button class="btn btn-primary">Send</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Toggle new-chat dropdowns
    document.getElementById('new-desk').addEventListener('click', () =>
      document.getElementById('new-list-desk').classList.toggle('d-none')
    );
    document.getElementById('new-mob').addEventListener('click', () =>
      document.getElementById('new-list-mob').classList.toggle('d-none')
    );

    // Simple search wiring
    function wireSearch(inputId, listSelector) {
      document.getElementById(inputId).addEventListener('input', e => {
        const q = e.target.value.toLowerCase();
        document.querySelectorAll(listSelector).forEach(li => {
          li.style.display = li.textContent.toLowerCase().includes(q) ? '' : 'none';
        });
      });
    }
    wireSearch('search-desk', '#conv-desk li');
    wireSearch('search-mob',  '#conv-mob li');
</script>
<!-- Auto-redirect inbox → first thread -->
<script th:if="${firstUsername != null and selectedUsername == null}">
    /*<![CDATA[*/
    if (!new URLSearchParams(window.location.search).has('noRedirect')) {
        window.location.href = /*[[ @{/messages/} ]]*/ + '[[${firstUsername}]]';
    }
    /*]]>*/
</script>
<script>
    // BACK‐BUTTON: show the list view, hide the chat view
    document.getElementById('back-btn').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('list-pane').classList.remove('d-none');
      document.getElementById('chat-pane').classList.add('d-none');
    });
</script>
<footer class="bg-light text-center text-muted py-3 mt-auto shadow-sm" style="position: fixed; bottom: 0; width: 100%;">
    <div>
        © 2025 Social Media Platform. All rights reserved.
    </div>
</footer>

</body>
</html>